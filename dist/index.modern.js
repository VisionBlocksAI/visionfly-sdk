function e(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function r(r,t){var n="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(n)return(n=n.call(r)).next.bind(n);if(Array.isArray(r)||(n=function(r,t){if(r){if("string"==typeof r)return e(r,t);var n={}.toString.call(r).slice(8,-1);return"Object"===n&&r.constructor&&(n=r.constructor.name),"Map"===n||"Set"===n?Array.from(r):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(r,t):void 0}}(r))||t&&r&&"number"==typeof r.length){n&&(r=n);var o=0;return function(){return o>=r.length?{done:!0}:{done:!1,value:r[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function t(){return t=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)({}).hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},t.apply(null,arguments)}function n(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var o=/*#__PURE__*/function(){function e(e){var r=e.apiSecret,t=e.baseUrl,n=void 0===t?"https://api.visionfly.ai":t,o=e.cdnUrl,i=void 0===o?"https://cdn.visionfly.ai":o;this.apiKey=e.apiKey,this.apiSecret=r,this.baseUrl=n,this.cdnUrl=i,this.token=null,this.tokenExpiry=null,this.refreshToken=null,this.urlCache=new Map}var o=e.prototype;return o._ensureAuthenticated=function(){try{var e=this;return e.token&&e.tokenExpiry&&e.tokenExpiry>Date.now()?Promise.resolve():Promise.resolve(e._authenticate()).then(function(){})}catch(e){return Promise.reject(e)}},o._authenticate=function(){try{var e=this;return Promise.resolve(n(function(){return Promise.resolve(fetch(e.baseUrl+"/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:e.apiKey,api_secret:e.apiSecret})})).then(function(r){function t(t){return Promise.resolve(r.json()).then(function(r){e.token=r.access_token,e.refreshToken=r.refresh_token,e.tokenExpiry=Date.now()+1e3*r.expires_in-3e5})}var n=function(){if(!r.ok)return Promise.resolve(r.json()).then(function(e){throw new Error(e.msg||"Authentication failed")})}();return n&&n.then?n.then(t):t()})},function(e){throw console.error("VisionFly authentication error:",e),e}))}catch(e){return Promise.reject(e)}},o._refreshToken=function(){try{var e=this;return Promise.resolve(n(function(){return Promise.resolve(fetch(e.baseUrl+"/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e.refreshToken})})).then(function(r){function t(t){return Promise.resolve(r.json()).then(function(r){e.token=r.access_token,e.refreshToken=r.refresh_token,e.tokenExpiry=Date.now()+1e3*r.expires_in-3e5})}var n=function(){if(!r.ok)return Promise.resolve(r.json()).then(function(e){throw new Error(e.msg||"Token refresh failed")})}();return n&&n.then?n.then(t):t()})},function(e){throw console.error("VisionFly token refresh error:",e),e}))}catch(e){return Promise.reject(e)}},o._request=function(e,r){void 0===r&&(r={});try{var o=this;return Promise.resolve(o._ensureAuthenticated()).then(function(){var i={headers:{Authorization:"Bearer "+o.token}},s=t({},i,r,{headers:t({},i.headers,r.headers)});return n(function(){return Promise.resolve(fetch(""+o.baseUrl+e,s)).then(function(r){function t(){function e(e){return r.json()}var t=function(){if(!r.ok)return Promise.resolve(r.json()).then(function(e){throw new Error(e.msg||"Request failed with status "+r.status)})}();return t&&t.then?t.then(e):e()}var n=function(){if(401===r.status)return Promise.resolve(o._refreshToken()).then(function(){return s.headers.Authorization="Bearer "+o.token,Promise.resolve(fetch(""+o.baseUrl+e,s)).then(function(e){r=e})})}();return n&&n.then?n.then(t):t()})},function(e){throw console.error("VisionFly request error:",e),e})})}catch(e){return Promise.reject(e)}},o.getImageUrl=function(e){try{var r=this,t=JSON.stringify(e);if(r.urlCache.has(t))return Promise.resolve(r.urlCache.get(t));var n=new URLSearchParams,o={src:"src",width:"w",height:"h",quality:"q",format:"f",blur:"blur",sharpen:"sharp",brightness:"bri",contrast:"con",saturation:"sat",hue:"hue"};Object.entries(e).forEach(function(e){var r=e[0],t=e[1];null!=t&&n.append(o[r]||r,t)});var i="/transform?"+n.toString();return Promise.resolve(r._request(i)).then(function(e){if(!e.public_url)throw new Error("Transform API did not return a public_url");return r.urlCache.set(t,e.public_url),e.public_url})}catch(e){return Promise.reject(e)}},o.getSrcSet=function(e){try{var t=this,n=e.src,o=e.widths,i=void 0===o?[400,800,1200]:o,s=e.format,a=void 0===s?"auto":s,u=e.quality,c=void 0===u?80:u,h=Array.isArray(i)?i.join(","):i,l=new URLSearchParams({src:n,w:h,f:a,q:c});return Promise.resolve(t._request("/generate/srcset?"+l.toString())).then(function(e){var n=e.srcset.split(",").map(function(e){return e.trim()});return Promise.resolve(Promise.all(n.map(function(e){try{for(var n,o=e.split(" "),i=o[1],s=new URL(o[0]),a={},u={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"},c=r(s.searchParams.entries());!(n=c()).done;){var h=n.value,l=h[0];a[u[l]||l]=h[1]}return Promise.resolve(t.getImageUrl(a)).then(function(e){return e+" "+i})}catch(e){return Promise.reject(e)}}))).then(function(n){for(var o,i={},s={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"},a=r(new URL(e.default).searchParams.entries());!(o=a()).done;){var u=o.value,c=u[0];i[s[c]||c]=u[1]}return Promise.resolve(t.getImageUrl(i)).then(function(r){return{srcset:n.join(", "),sizes:e.sizes,default:r}})})})}catch(e){return Promise.reject(e)}},o.uploadImage=function(e){try{var r=e.file,t=e.projectId,n=e.publicId,o=new FormData;return o.append("file",r),o.append("project_id",t),n&&o.append("public_id",n),Promise.resolve(this._request("/upload/",{method:"POST",body:o,headers:{}}))}catch(e){return Promise.reject(e)}},o.clearCache=function(){this.urlCache.clear()},e}();export{o as default};
//# sourceMappingURL=index.modern.js.map
