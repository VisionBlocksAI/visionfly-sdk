"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=t(e);function a(){return a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)({}).hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},a.apply(null,arguments)}class s{constructor({apiKey:e,apiSecret:t,baseUrl:r="https://api.visionfly.ai",cdnUrl:a="https://cdn.visionfly.ai"}){this.apiKey=e,this.apiSecret=t,this.baseUrl=r,this.cdnUrl=a,this.token=null,this.tokenExpiry=null,this.refreshToken=null,this.urlCache=new Map}async _ensureAuthenticated(){this.token&&this.tokenExpiry&&this.tokenExpiry>Date.now()||await this._authenticate()}async _authenticate(){try{const e=await fetch(`${this.baseUrl}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:this.apiKey,api_secret:this.apiSecret})});if(!e.ok){const t=await e.json();throw new Error(t.msg||"Authentication failed")}const t=await e.json();this.token=t.access_token,this.refreshToken=t.refresh_token,this.tokenExpiry=Date.now()+1e3*t.expires_in-3e5}catch(e){throw console.error("VisionFly authentication error:",e),e}}async _refreshToken(){try{const e=await fetch(`${this.baseUrl}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok){const t=await e.json();throw new Error(t.msg||"Token refresh failed")}const t=await e.json();this.token=t.access_token,this.refreshToken=t.refresh_token,this.tokenExpiry=Date.now()+1e3*t.expires_in-3e5}catch(e){throw console.error("VisionFly token refresh error:",e),e}}async _request(e,t={}){await this._ensureAuthenticated();const r={headers:{Authorization:`Bearer ${this.token}`}},a={...r,...t,headers:{...r.headers,...t.headers}};try{let t=await fetch(`${this.baseUrl}${e}`,a);if(401===t.status&&(await this._refreshToken(),a.headers.Authorization=`Bearer ${this.token}`,t=await fetch(`${this.baseUrl}${e}`,a)),!t.ok){const e=await t.json();throw new Error(e.msg||`Request failed with status ${t.status}`)}return t.json()}catch(e){throw console.error("VisionFly request error:",e),e}}async getImageUrl(e){const t=JSON.stringify(e);if(this.urlCache.has(t))return this.urlCache.get(t);const r=new URLSearchParams,a={src:"src",width:"w",height:"h",quality:"q",format:"f",blur:"blur",sharpen:"sharp",brightness:"bri",contrast:"con",saturation:"sat",hue:"hue"};Object.entries(e).forEach((([e,t])=>{if(null!=t){const s=a[e]||e;r.append(s,t)}}));const s=`/transform?${r.toString()}`,i=await this._request(s);if(!i.public_url)throw new Error("Transform API did not return a public_url");return this.urlCache.set(t,i.public_url),i.public_url}async getSrcSet(e){const{src:t,widths:r=[400,800,1200],format:a="auto",quality:s=80}=e,i=Array.isArray(r)?r.join(","):r,n=new URLSearchParams({src:t,w:i,f:a,q:s}),o=await this._request(`/generate/srcset?${n.toString()}`),l=o.srcset.split(",").map((e=>e.trim())),c=await Promise.all(l.map((async e=>{const[t,r]=e.split(" "),a=new URL(t),s={},i={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[e,t]of a.searchParams.entries()){s[i[e]||e]=t}return`${await this.getImageUrl(s)} ${r}`}))),h=new URL(o.default),u={},d={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[e,t]of h.searchParams.entries()){u[d[e]||e]=t}const f=await this.getImageUrl(u);return{srcset:c.join(", "),sizes:o.sizes,default:f}}async uploadImage(e){const{file:t,projectId:r,publicId:a}=e,s=new FormData;return s.append("file",t),s.append("project_id",r),a&&s.append("public_id",a),this._request("/upload/",{method:"POST",body:s,headers:{}})}clearCache(){this.urlCache.clear()}}const i=e.createContext(null),n=()=>{const t=e.useContext(i);if(!t)throw new Error("useVisionFly must be used within a VisionFlyProvider");return t};exports.VFImage=({src:t,width:s,height:i,quality:o,format:l,blur:c,sharpen:h,brightness:u,contrast:d,saturation:f,hue:p,alt:y="",className:m="",style:g={},loading:w="lazy",...b})=>{const{client:k,ready:v}=n(),[S,E]=e.useState(""),[_,$]=e.useState(!0),[x,j]=e.useState(null);return e.useEffect((()=>{if(!v||!t)return;let e=!0;$(!0);return(async()=>{try{const r=await k.getImageUrl({src:t,width:s,height:i,quality:o,format:l,blur:c,sharpen:h,brightness:u,contrast:d,saturation:f,hue:p});e&&(E(r),$(!1))}catch(t){e&&(console.error("Failed to load image:",t),j(t),$(!1))}})(),()=>{e=!1}}),[k,v,t,s,i,o,l,c,h,u,d,f,p]),_?r.default.createElement("div",a({className:`vf-image-placeholder ${m}`,style:{width:s?`${s}px`:"100%",height:i?`${i}px`:"auto",backgroundColor:"#f0f0f0",...g}},b)):x?r.default.createElement("div",a({className:`vf-image-error ${m}`,style:{width:s?`${s}px`:"100%",height:i?`${i}px`:"auto",backgroundColor:"#ff5555",display:"flex",alignItems:"center",justifyContent:"center",color:"white",...g}},b),"Error loading image"):r.default.createElement("img",a({src:S,alt:y,width:s,height:i,loading:w,className:`vf-image ${m}`,style:g},b))},exports.VFResponsiveImage=({src:t,widths:s,sizes:i,quality:o,format:l,alt:c="",className:h="",style:u={},loading:d="lazy",...f})=>{const{client:p,ready:y}=n(),[m,g]=e.useState(null),[w,b]=e.useState(!0),[k,v]=e.useState(null);return e.useEffect((()=>{if(!y||!t)return;let e=!0;b(!0);return(async()=>{try{const r=await p.getSrcSet({src:t,widths:s,format:l,quality:o});e&&(g(r),b(!1))}catch(t){e&&(console.error("Failed to load srcset:",t),v(t),b(!1))}})(),()=>{e=!1}}),[p,y,t,s&&JSON.stringify(s),i,o,l]),w?r.default.createElement("div",a({className:`vf-image-placeholder ${h}`,style:{width:"100%",height:"300px",backgroundColor:"#f0f0f0",...u}},f)):k?r.default.createElement("div",a({className:`vf-image-error ${h}`,style:{width:"100%",height:"300px",backgroundColor:"#ff5555",display:"flex",alignItems:"center",justifyContent:"center",color:"white",...u}},f),"Error loading image"):r.default.createElement("img",a({src:m.default,srcSet:m.srcset,sizes:i||m.sizes,alt:c,loading:d,className:`vf-responsive-image ${h}`,style:u},f))},exports.VFUploader=({projectId:t,onUpload:s,onError:i,publicId:o,multiple:l=!1,className:c="",style:h={},buttonClassName:u="",buttonStyle:d={},buttonText:f="Upload Image",children:p,...y})=>{const{client:m,ready:g}=n(),[w,b]=e.useState(!1),k=e.useRef(null),v=e.useCallback((async e=>{const r=e.target.files;if(r&&0!==r.length){b(!0);try{if(l){const e=await Promise.all(Array.from(r).map((e=>m.uploadImage({file:e,projectId:t,publicId:o||void 0}))));b(!1),s&&s(e)}else{const e=await m.uploadImage({file:r[0],projectId:t,publicId:o||void 0});b(!1),s&&s(e)}k.current&&(k.current.value="")}catch(e){b(!1),console.error("Upload failed:",e),i&&i(e)}}}),[m,t,o,l,s,i]),S=p||r.default.createElement("button",{type:"button",className:`vf-upload-button ${u}`,style:d,disabled:w||!g},w?"Uploading...":f);return r.default.createElement("div",a({className:`vf-uploader ${c}`,style:h},y),r.default.createElement("input",{ref:k,type:"file",accept:"image/*",multiple:l,onChange:v,style:{display:"none"},id:"vf-file-input"}),r.default.createElement("label",{htmlFor:"vf-file-input"},S))},exports.VisionFlyProvider=({config:t,children:a})=>{const[n]=e.useState((()=>new s(t))),[o,l]=e.useState(!1);e.useEffect((()=>{(async()=>{try{await n._ensureAuthenticated(),l(!0)}catch(e){console.error("Failed to initialize VisionFly client:",e)}})()}),[n]);const c={client:n,ready:o};return r.default.createElement(i.Provider,{value:c},a)},exports.useVisionFly=n;
//# sourceMappingURL=react.js.map
