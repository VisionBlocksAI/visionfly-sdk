import{createContext as t,useState as e,useEffect as r,useContext as a,useRef as s,useCallback as i}from"react";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var a in r)({}).hasOwnProperty.call(r,a)&&(t[a]=r[a])}return t},n.apply(null,arguments)}function o(t,e){if(null==t)return{};var r={};for(var a in t)if({}.hasOwnProperty.call(t,a)){if(-1!==e.indexOf(a))continue;r[a]=t[a]}return r}class l{constructor({apiKey:t,apiSecret:e,baseUrl:r="https://api.visionfly.ai",cdnUrl:a="https://cdn.visionfly.ai"}){this.apiKey=t,this.apiSecret=e,this.baseUrl=r,this.cdnUrl=a,this.token=null,this.tokenExpiry=null,this.refreshToken=null,this.urlCache=new Map}async _ensureAuthenticated(){this.token&&this.tokenExpiry&&this.tokenExpiry>Date.now()||await this._authenticate()}async _authenticate(){try{const t=await fetch(`${this.baseUrl}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:this.apiKey,api_secret:this.apiSecret})});if(!t.ok){const e=await t.json();throw new Error(e.msg||"Authentication failed")}const e=await t.json();this.token=e.access_token,this.refreshToken=e.refresh_token,this.tokenExpiry=Date.now()+1e3*e.expires_in-3e5}catch(t){throw console.error("VisionFly authentication error:",t),t}}async _refreshToken(){try{const t=await fetch(`${this.baseUrl}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})});if(!t.ok){const e=await t.json();throw new Error(e.msg||"Token refresh failed")}const e=await t.json();this.token=e.access_token,this.refreshToken=e.refresh_token,this.tokenExpiry=Date.now()+1e3*e.expires_in-3e5}catch(t){throw console.error("VisionFly token refresh error:",t),t}}async _request(t,e={}){await this._ensureAuthenticated();const r={headers:{Authorization:`Bearer ${this.token}`}},a=n({},r,e,{headers:n({},r.headers,e.headers)});try{let e=await fetch(`${this.baseUrl}${t}`,a);if(401===e.status&&(await this._refreshToken(),a.headers.Authorization=`Bearer ${this.token}`,e=await fetch(`${this.baseUrl}${t}`,a)),!e.ok){const t=await e.json();throw new Error(t.msg||`Request failed with status ${e.status}`)}return e.json()}catch(t){throw console.error("VisionFly request error:",t),t}}async getImageUrl(t){const e=JSON.stringify(t);if(this.urlCache.has(e))return this.urlCache.get(e);const r=new URLSearchParams,a={src:"src",width:"w",height:"h",quality:"q",format:"f",blur:"blur",sharpen:"sharp",brightness:"bri",contrast:"con",saturation:"sat",hue:"hue"};Object.entries(t).forEach(([t,e])=>{null!=e&&r.append(a[t]||t,e)});const s=`/transform?${r.toString()}`,i=await this._request(s);if(!i.public_url)throw new Error("Transform API did not return a public_url");return this.urlCache.set(e,i.public_url),i.public_url}async getSrcSet(t){var e=this;const{src:r,widths:a=[400,800,1200],format:s="auto",quality:i=80}=t,n=Array.isArray(a)?a.join(","):a,o=new URLSearchParams({src:r,w:n,f:s,q:i}),l=await this._request(`/generate/srcset?${o.toString()}`),c=l.srcset.split(",").map(t=>t.trim()),h=await Promise.all(c.map(async function(t){const[r,a]=t.split(" "),s=new URL(r),i={},n={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[t,e]of s.searchParams.entries())i[n[t]||t]=e;return`${await e.getImageUrl(i)} ${a}`})),u=new URL(l.default),d={},f={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[t,e]of u.searchParams.entries())d[f[t]||t]=e;const p=await this.getImageUrl(d);return{srcset:h.join(", "),sizes:l.sizes,default:p}}async uploadImage(t){const{file:e,projectId:r,publicId:a}=t,s=new FormData;return s.append("file",e),s.append("project_id",r),a&&s.append("public_id",a),this._request("/upload/",{method:"POST",body:s,headers:{}})}clearCache(){this.urlCache.clear()}}const c=["src","width","height","quality","format","blur","sharpen","brightness","contrast","saturation","hue","alt","className","style","loading"],u=["src","widths","sizes","quality","format","alt","className","style","loading"],d=["projectId","onUpload","onError","publicId","multiple","className","style","buttonClassName","buttonStyle","buttonText","children"],f=t(null);function p({config:t,children:a}){const[s]=e(()=>new l(t)),[i,n]=e(!1);return r(()=>{(async()=>{try{await s._ensureAuthenticated(),n(!0)}catch(t){console.error("Failed to initialize VisionFly client:",t)}})()},[s]),h(f.Provider,{value:{client:s,ready:i}},a)}function y(){const t=a(f);if(!t)throw new Error("useVisionFly must be used within a VisionFlyProvider");return t}function g(t){let{src:a,width:s,height:i,quality:l,format:u,blur:d,sharpen:f,brightness:p,contrast:g,saturation:m,hue:w,alt:b="",className:v="",style:k={},loading:_="lazy"}=t,$=o(t,c);const{client:I,ready:U}=y(),[j,S]=e(""),[q,N]=e(!0),[x,C]=e(null);return r(()=>{if(!U||!a)return;let t=!0;return N(!0),(async()=>{try{const e=await I.getImageUrl({src:a,width:s,height:i,quality:l,format:u,blur:d,sharpen:f,brightness:p,contrast:g,saturation:m,hue:w});t&&(S(e),N(!1))}catch(e){t&&(console.error("Failed to load image:",e),C(e),N(!1))}})(),()=>{t=!1}},[I,U,a,s,i,l,u,d,f,p,g,m,w]),q?h("div",n({className:`vf-image-placeholder ${v}`,style:n({width:s?`${s}px`:"100%",height:i?`${i}px`:"auto",backgroundColor:"#f0f0f0"},k)},$)):x?h("div",n({className:`vf-image-error ${v}`,style:n({width:s?`${s}px`:"100%",height:i?`${i}px`:"auto",backgroundColor:"#ff5555",display:"flex",alignItems:"center",justifyContent:"center",color:"white"},k)},$),"Error loading image"):h("img",n({src:j,alt:b,width:s,height:i,loading:_,className:`vf-image ${v}`,style:k},$))}function m(t){let{src:a,widths:s,sizes:i,quality:l,format:c,alt:d="",className:f="",style:p={},loading:g="lazy"}=t,m=o(t,u);const{client:w,ready:b}=y(),[v,k]=e(null),[_,$]=e(!0),[I,U]=e(null);return r(()=>{if(!b||!a)return;let t=!0;return $(!0),(async()=>{try{const e=await w.getSrcSet({src:a,widths:s,format:c,quality:l});t&&(k(e),$(!1))}catch(e){t&&(console.error("Failed to load srcset:",e),U(e),$(!1))}})(),()=>{t=!1}},[w,b,a,s&&JSON.stringify(s),i,l,c]),_?h("div",n({className:`vf-image-placeholder ${f}`,style:n({width:"100%",height:"300px",backgroundColor:"#f0f0f0"},p)},m)):I?h("div",n({className:`vf-image-error ${f}`,style:n({width:"100%",height:"300px",backgroundColor:"#ff5555",display:"flex",alignItems:"center",justifyContent:"center",color:"white"},p)},m),"Error loading image"):h("img",n({src:v.default,srcSet:v.srcset,sizes:i||v.sizes,alt:d,loading:g,className:`vf-responsive-image ${f}`,style:p},m))}function w(t){let{projectId:r,onUpload:a,onError:l,publicId:c,multiple:u=!1,className:f="",style:p={},buttonClassName:g="",buttonStyle:m={},buttonText:w="Upload Image",children:b}=t,v=o(t,d);const{client:k,ready:_}=y(),[$,I]=e(!1),U=s(null),j=i(async t=>{const e=t.target.files;if(e&&0!==e.length){I(!0);try{if(u){const t=await Promise.all(Array.from(e).map(t=>k.uploadImage({file:t,projectId:r,publicId:c||void 0})));I(!1),a&&a(t)}else{const t=await k.uploadImage({file:e[0],projectId:r,publicId:c||void 0});I(!1),a&&a(t)}U.current&&(U.current.value="")}catch(t){I(!1),console.error("Upload failed:",t),l&&l(t)}}},[k,r,c,u,a,l]),S=b||h("button",{type:"button",className:`vf-upload-button ${g}`,style:m,disabled:$||!_},$?"Uploading...":w);return h("div",n({className:`vf-uploader ${f}`,style:p},v),h("input",{ref:U,type:"file",accept:"image/*",multiple:u,onChange:j,style:{display:"none"},id:"vf-file-input"}),h("label",{htmlFor:"vf-file-input"},S))}var b={VisionFlyProvider:p,useVisionFly:y,VFImage:g,VFResponsiveImage:m,VFUploader:w};export{g as VFImage,m as VFResponsiveImage,w as VFUploader,p as VisionFlyProvider,b as default,y as useVisionFly};
//# sourceMappingURL=react.modern.mjs.map
