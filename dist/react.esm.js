import e,{useState as t,useEffect as r,useContext as a,useRef as s,useCallback as i,createContext as n}from"react";function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)({}).hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},o.apply(null,arguments)}class l{constructor({apiKey:e,apiSecret:t,baseUrl:r="https://api.visionfly.ai",cdnUrl:a="https://cdn.visionfly.ai"}){this.apiKey=e,this.apiSecret=t,this.baseUrl=r,this.cdnUrl=a,this.token=null,this.tokenExpiry=null,this.refreshToken=null,this.urlCache=new Map}async _ensureAuthenticated(){this.token&&this.tokenExpiry&&this.tokenExpiry>Date.now()||await this._authenticate()}async _authenticate(){try{const e=await fetch(`${this.baseUrl}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:this.apiKey,api_secret:this.apiSecret})});if(!e.ok){const t=await e.json();throw new Error(t.msg||"Authentication failed")}const t=await e.json();this.token=t.access_token,this.refreshToken=t.refresh_token,this.tokenExpiry=Date.now()+1e3*t.expires_in-3e5}catch(e){throw console.error("VisionFly authentication error:",e),e}}async _refreshToken(){try{const e=await fetch(`${this.baseUrl}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok){const t=await e.json();throw new Error(t.msg||"Token refresh failed")}const t=await e.json();this.token=t.access_token,this.refreshToken=t.refresh_token,this.tokenExpiry=Date.now()+1e3*t.expires_in-3e5}catch(e){throw console.error("VisionFly token refresh error:",e),e}}async _request(e,t={}){await this._ensureAuthenticated();const r={headers:{Authorization:`Bearer ${this.token}`}},a={...r,...t,headers:{...r.headers,...t.headers}};try{let t=await fetch(`${this.baseUrl}${e}`,a);if(401===t.status&&(await this._refreshToken(),a.headers.Authorization=`Bearer ${this.token}`,t=await fetch(`${this.baseUrl}${e}`,a)),!t.ok){const e=await t.json();throw new Error(e.msg||`Request failed with status ${t.status}`)}return t.json()}catch(e){throw console.error("VisionFly request error:",e),e}}async getImageUrl(e){const t=JSON.stringify(e);if(this.urlCache.has(t))return this.urlCache.get(t);const r=new URLSearchParams,a={src:"src",width:"w",height:"h",quality:"q",format:"f",blur:"blur",sharpen:"sharp",brightness:"bri",contrast:"con",saturation:"sat",hue:"hue"};Object.entries(e).forEach((([e,t])=>{if(null!=t){const s=a[e]||e;r.append(s,t)}}));const s=`/transform?${r.toString()}`,i=await this._request(s);if(!i.public_url)throw new Error("Transform API did not return a public_url");return this.urlCache.set(t,i.public_url),i.public_url}async getSrcSet(e){const{src:t,widths:r=[400,800,1200],format:a="auto",quality:s=80}=e,i=Array.isArray(r)?r.join(","):r,n=new URLSearchParams({src:t,w:i,f:a,q:s}),o=await this._request(`/generate/srcset?${n.toString()}`),l=o.srcset.split(",").map((e=>e.trim())),c=await Promise.all(l.map((async e=>{const[t,r]=e.split(" "),a=new URL(t),s={},i={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[e,t]of a.searchParams.entries()){s[i[e]||e]=t}return`${await this.getImageUrl(s)} ${r}`}))),h=new URL(o.default),u={},d={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[e,t]of h.searchParams.entries()){u[d[e]||e]=t}const f=await this.getImageUrl(u);return{srcset:c.join(", "),sizes:o.sizes,default:f}}async uploadImage(e){const{file:t,projectId:r,publicId:a}=e,s=new FormData;return s.append("file",t),s.append("project_id",r),a&&s.append("public_id",a),this._request("/upload/",{method:"POST",body:s,headers:{}})}clearCache(){this.urlCache.clear()}}const c=n(null),h=({config:a,children:s})=>{const[i]=t((()=>new l(a))),[n,o]=t(!1);r((()=>{(async()=>{try{await i._ensureAuthenticated(),o(!0)}catch(e){console.error("Failed to initialize VisionFly client:",e)}})()}),[i]);const h={client:i,ready:n};return e.createElement(c.Provider,{value:h},s)},u=()=>{const e=a(c);if(!e)throw new Error("useVisionFly must be used within a VisionFlyProvider");return e},d=({src:a,width:s,height:i,quality:n,format:l,blur:c,sharpen:h,brightness:d,contrast:f,saturation:p,hue:y,alt:m="",className:g="",style:w={},loading:b="lazy",...k})=>{const{client:v,ready:_}=u(),[E,$]=t(""),[j,S]=t(!0),[U,I]=t(null);return r((()=>{if(!_||!a)return;let e=!0;S(!0);return(async()=>{try{const t=await v.getImageUrl({src:a,width:s,height:i,quality:n,format:l,blur:c,sharpen:h,brightness:d,contrast:f,saturation:p,hue:y});e&&($(t),S(!1))}catch(t){e&&(console.error("Failed to load image:",t),I(t),S(!1))}})(),()=>{e=!1}}),[v,_,a,s,i,n,l,c,h,d,f,p,y]),j?e.createElement("div",o({className:`vf-image-placeholder ${g}`,style:{width:s?`${s}px`:"100%",height:i?`${i}px`:"auto",backgroundColor:"#f0f0f0",...w}},k)):U?e.createElement("div",o({className:`vf-image-error ${g}`,style:{width:s?`${s}px`:"100%",height:i?`${i}px`:"auto",backgroundColor:"#ff5555",display:"flex",alignItems:"center",justifyContent:"center",color:"white",...w}},k),"Error loading image"):e.createElement("img",o({src:E,alt:m,width:s,height:i,loading:b,className:`vf-image ${g}`,style:w},k))},f=({src:a,widths:s,sizes:i,quality:n,format:l,alt:c="",className:h="",style:d={},loading:f="lazy",...p})=>{const{client:y,ready:m}=u(),[g,w]=t(null),[b,k]=t(!0),[v,_]=t(null);return r((()=>{if(!m||!a)return;let e=!0;k(!0);return(async()=>{try{const t=await y.getSrcSet({src:a,widths:s,format:l,quality:n});e&&(w(t),k(!1))}catch(t){e&&(console.error("Failed to load srcset:",t),_(t),k(!1))}})(),()=>{e=!1}}),[y,m,a,s&&JSON.stringify(s),i,n,l]),b?e.createElement("div",o({className:`vf-image-placeholder ${h}`,style:{width:"100%",height:"300px",backgroundColor:"#f0f0f0",...d}},p)):v?e.createElement("div",o({className:`vf-image-error ${h}`,style:{width:"100%",height:"300px",backgroundColor:"#ff5555",display:"flex",alignItems:"center",justifyContent:"center",color:"white",...d}},p),"Error loading image"):e.createElement("img",o({src:g.default,srcSet:g.srcset,sizes:i||g.sizes,alt:c,loading:f,className:`vf-responsive-image ${h}`,style:d},p))},p=({projectId:r,onUpload:a,onError:n,publicId:l,multiple:c=!1,className:h="",style:d={},buttonClassName:f="",buttonStyle:p={},buttonText:y="Upload Image",children:m,...g})=>{const{client:w,ready:b}=u(),[k,v]=t(!1),_=s(null),E=i((async e=>{const t=e.target.files;if(t&&0!==t.length){v(!0);try{if(c){const e=await Promise.all(Array.from(t).map((e=>w.uploadImage({file:e,projectId:r,publicId:l||void 0}))));v(!1),a&&a(e)}else{const e=await w.uploadImage({file:t[0],projectId:r,publicId:l||void 0});v(!1),a&&a(e)}_.current&&(_.current.value="")}catch(e){v(!1),console.error("Upload failed:",e),n&&n(e)}}}),[w,r,l,c,a,n]),$=m||e.createElement("button",{type:"button",className:`vf-upload-button ${f}`,style:p,disabled:k||!b},k?"Uploading...":y);return e.createElement("div",o({className:`vf-uploader ${h}`,style:d},g),e.createElement("input",{ref:_,type:"file",accept:"image/*",multiple:c,onChange:E,style:{display:"none"},id:"vf-file-input"}),e.createElement("label",{htmlFor:"vf-file-input"},$))};export{d as VFImage,f as VFResponsiveImage,p as VFUploader,h as VisionFlyProvider,u as useVisionFly};
//# sourceMappingURL=react.esm.js.map
