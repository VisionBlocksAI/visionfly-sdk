function t(){return t=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)({}).hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t},t.apply(null,arguments)}class e{constructor({apiKey:t,apiSecret:e,baseUrl:r="https://api.visionfly.ai",cdnUrl:s="https://cdn.visionfly.ai"}){this.apiKey=t,this.apiSecret=e,this.baseUrl=r,this.cdnUrl=s,this.token=null,this.tokenExpiry=null,this.refreshToken=null,this.urlCache=new Map}async _ensureAuthenticated(){this.token&&this.tokenExpiry&&this.tokenExpiry>Date.now()||await this._authenticate()}async _authenticate(){try{const t=await fetch(`${this.baseUrl}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:this.apiKey,api_secret:this.apiSecret})});if(!t.ok){const e=await t.json();throw new Error(e.msg||"Authentication failed")}const e=await t.json();this.token=e.access_token,this.refreshToken=e.refresh_token,this.tokenExpiry=Date.now()+1e3*e.expires_in-3e5}catch(t){throw console.error("VisionFly authentication error:",t),t}}async _refreshToken(){try{const t=await fetch(`${this.baseUrl}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.refreshToken})});if(!t.ok){const e=await t.json();throw new Error(e.msg||"Token refresh failed")}const e=await t.json();this.token=e.access_token,this.refreshToken=e.refresh_token,this.tokenExpiry=Date.now()+1e3*e.expires_in-3e5}catch(t){throw console.error("VisionFly token refresh error:",t),t}}async _request(e,r={}){await this._ensureAuthenticated();const s={headers:{Authorization:`Bearer ${this.token}`}},a=t({},s,r,{headers:t({},s.headers,r.headers)});try{let t=await fetch(`${this.baseUrl}${e}`,a);if(401===t.status&&(await this._refreshToken(),a.headers.Authorization=`Bearer ${this.token}`,t=await fetch(`${this.baseUrl}${e}`,a)),!t.ok){const e=await t.json();throw new Error(e.msg||`Request failed with status ${t.status}`)}return t.json()}catch(t){throw console.error("VisionFly request error:",t),t}}async getImageUrl(t){const e=JSON.stringify(t);if(this.urlCache.has(e))return this.urlCache.get(e);const r=new URLSearchParams,s={src:"src",width:"w",height:"h",quality:"q",format:"f",blur:"blur",sharpen:"sharp",brightness:"bri",contrast:"con",saturation:"sat",hue:"hue"};Object.entries(t).forEach(([t,e])=>{null!=e&&r.append(s[t]||t,e)});const a=`/transform?${r.toString()}`,i=await this._request(a);if(!i.public_url)throw new Error("Transform API did not return a public_url");return this.urlCache.set(e,i.public_url),i.public_url}async getSrcSet(t){var e=this;const{src:r,widths:s=[400,800,1200],format:a="auto",quality:i=80}=t,n=Array.isArray(s)?s.join(","):s,o=new URLSearchParams({src:r,w:n,f:a,q:i}),h=await this._request(`/generate/srcset?${o.toString()}`),c=h.srcset.split(",").map(t=>t.trim()),l=await Promise.all(c.map(async function(t){const[r,s]=t.split(" "),a=new URL(r),i={},n={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[t,e]of a.searchParams.entries())i[n[t]||t]=e;return`${await e.getImageUrl(i)} ${s}`})),u=new URL(h.default),p={},f={src:"src",w:"width",h:"height",q:"quality",f:"format",blur:"blur",sharp:"sharpen",bri:"brightness",con:"contrast",sat:"saturation",hue:"hue"};for(const[t,e]of u.searchParams.entries())p[f[t]||t]=e;const w=await this.getImageUrl(p);return{srcset:l.join(", "),sizes:h.sizes,default:w}}async uploadImage(t){const{file:e,projectId:r,publicId:s}=t,a=new FormData;return a.append("file",e),a.append("project_id",r),s&&a.append("public_id",s),this._request("/upload/",{method:"POST",body:a,headers:{}})}clearCache(){this.urlCache.clear()}}export{e as default};
//# sourceMappingURL=index.modern.mjs.map
